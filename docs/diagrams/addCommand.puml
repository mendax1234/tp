@startuml
!theme plain
' --- Participants ---
actor "caller" as Caller
participant "cmd:AddCommand" as AddCmd #LightGreen
participant "AddCommand.addModule()" as AddHelper #LightGreen
participant "allModulesData:Map" as Cache
participant "tt:Timetable" as Timetable #LightBlue
' --- Dotted lifeline style ---
skinparam lifeline {
    strategy dotted
}
' --- Flow ---
Caller -> AddCmd : execute()
activate AddCmd
AddCmd -> AddHelper : addModule(timetable, allModulesData, ...)
activate AddHelper

' Retriever is created at the start of the addModule method,
' before the cache check.
create participant "retriever:ModuleRetriever" as Retriever #Plum
AddHelper -> Retriever ** : <<create>>

AddHelper -> Cache : get(moduleCode)
activate Cache
Cache --> AddHelper : module / null
deactivate Cache

opt module not in local data
    AddHelper -> Retriever : getModule(acadYear, moduleCode)
    activate Retriever

    alt module found
        Retriever --> AddHelper : module
        AddHelper -> Cache : put(moduleCode, module)
        activate Cache
        Cache --> AddHelper
        deactivate Cache
    else module not found (Exception or null)
        Retriever --> AddHelper : Exception / null
        deactivate Retriever
        AddHelper -->> AddHelper : throw ModuleNotFoundException
        AddHelper --> AddCmd : ModuleNotFoundException

        AddCmd -->> AddCmd : catch ModHeroException
        create participant "result:CommandResult" as ResultFail
        AddCmd -> ResultFail ** : <<create>>
        AddCmd --> Caller : result

        ' --- MISSING LINE ---
    end
end
' --- Timetable add logic ---
AddHelper -> Timetable : addModule(year, term, module, exemptedModules)
activate Timetable
note right of Timetable
  Validates prerequisites and conflicts.
  Throws exception if requirements unmet.
end note
alt prerequisites not met
    Timetable -->> AddHelper : throw PrerequisiteNotMetException
    AddHelper --> AddCmd : PrerequisiteNotMetException

    AddCmd -->> AddCmd : catch ModHeroException
    create participant "result:CommandResult" as ResultPrereq
    AddCmd -> ResultPrereq ** : <<create>>
    AddCmd --> Caller : result

else success
    Timetable --> AddHelper : void
    deactivate Timetable

    AddHelper --> AddCmd : void

    create participant "result:CommandResult" as ResultSuccess
    AddCmd -> ResultSuccess ** : <<create>>
    AddCmd --> Caller : result

end

@enduml
